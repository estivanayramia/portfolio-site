<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="build-version" content="20260218-e4616e0">
  <title>Error Dashboard - Estivan Ayramia</title>
  <link rel="stylesheet" href="/assets/css/dashboard.css?v=36c2000">
  <script src="/assets/js/hud-debug-patch.js"></script>
  <style>
    /* Critical CSS for fast initial render */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f1419;
      color: #e1d4c2;
      min-height: 100vh;
    }
    #loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 18px;
    }
  </style>
  <link rel="canonical" href="https://www.estivanayramia.com/dashboard">
</head>
<body>
  <div id="loading">Loading dashboard...</div>
  
  <!-- Login Screen -->
  <div id="login-screen" style="display: none;">
    <div class="login-container">
      <h1>ğŸ›¡ï¸ Error Dashboard</h1>
      <p>Protected area - Password required</p>

      <div class="login-help" style="margin-top: 10px;">
        <strong>Backend status</strong>
        <div style="margin-top: 6px; font-size: 13px; line-height: 1.4; opacity: 0.9;">
          <div>Health: <span id="login-backend-health">â€”</span></div>
          <div>Auth configured: <span id="login-auth-configured">â€”</span></div>
          <div>Auth source: <span id="login-auth-source">â€”</span></div>
          <div>Worker version: <span id="login-worker-version">â€”</span></div>
        </div>
      </div>
      <form id="login-form">
        <input 
          type="password" 
          id="password-input" 
          placeholder="Enter password" 
          autocomplete="current-password"
          required
        />
        <button type="submit">Login</button>
      </form>
      <p id="login-error" class="error-message" style="display: none;"></p>

      <div class="login-help">
        <strong>Demo mode</strong>: On Cloudflare Pages preview builds, the dashboard defaults to demo (offline) mode.
        Add <code>?force_real=1</code> to use the real backend.
        You can always force demo with <code>?demo=1</code>.
        <br>
        Demo mode never prompts for a password and never calls <code>/api/*</code>.
      </div>
    </div>
  </div>
  
  <!-- Dashboard -->
  <div id="dashboard" style="display: none;">
    <header class="dashboard-header">
      <h1>ğŸ› Error Monitoring Dashboard</h1>
      <div class="header-actions">
        <button id="refresh-btn" class="icon-btn" title="Refresh">ğŸ”„</button>
        <button id="export-btn" class="icon-btn" title="Export CSV">ğŸ“¥</button>
        <button id="logout-btn" class="icon-btn" title="Logout">ğŸšª</button>
      </div>
    </header>

    <nav class="dashboard-tabs" aria-label="Dashboard tabs">
      <button class="tab-btn active" data-tab="errors">ğŸ› Errors</button>
      <button class="tab-btn" data-tab="console">ğŸ“ Console</button>
      <button class="tab-btn" data-tab="network">ğŸŒ Network</button>
      <button class="tab-btn" data-tab="performance">âš¡ Performance</button>
      <button class="tab-btn" data-tab="redirects">ğŸ”€ Redirects</button>
      <button class="tab-btn" data-tab="storage">ğŸ’¾ Storage</button>
      <button class="tab-btn" data-tab="system">ğŸ–¥ï¸ System</button>
    </nav>
    
    <div class="dashboard-container">

      <!-- TAB 1: Errors (existing UI preserved) -->
      <div class="tab-panel active" id="tab-errors">
        <!-- Filters -->
        <div class="filters">
          <select id="status-filter">
            <option value="">All Statuses</option>
            <option value="new">New</option>
            <option value="investigating">Investigating</option>
            <option value="resolved">Resolved</option>
            <option value="ignored">Ignored</option>
          </select>
          
          <select id="category-filter">
            <option value="">All Categories</option>
            <option value="code_bug">Code Bug</option>
            <option value="async_bug">Async Bug</option>
            <option value="navigation">Navigation</option>
            <option value="connectivity">Connectivity</option>
            <option value="uncategorized">Uncategorized</option>
          </select>
          
          <button id="clear-filters">Clear Filters</button>
        </div>
        
        <!-- Stats -->
        <div class="stats">
          <div class="stat-card">
            <span class="stat-value" id="total-errors">0</span>
            <span class="stat-label">Total Errors</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="new-errors">0</span>
            <span class="stat-label">New</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="investigating-errors">0</span>
            <span class="stat-label">Investigating</span>
          </div>
        </div>

        <!-- Diagnostics Panel -->
        <section class="diagnostics-panel" aria-label="Diagnostics panel">
          <div class="diagnostics-header">
            <h2>Diagnostics</h2>
            <div class="diagnostics-actions">
              <button id="open-diagnostics" class="icon-btn">Open diagnostics</button>
              <button id="close-diagnostics" class="icon-btn" disabled>Close</button>
            </div>
          </div>
          <p class="diagnostics-help">Secure diagnostics are available only after login. Use this panel to inspect telemetry, errors, network, and layout issues.</p>
          <div id="diagnostics-status" class="diagnostics-status">Diagnostics not loaded.</div>
          <div id="diagnostics-mount" class="diagnostics-mount"></div>
        </section>
        
        <!-- Error Table -->
        <div class="table-container">
          <table class="error-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Message</th>
                <th>URL</th>
                <th>Category</th>
                <th>Status</th>
                <th>Bot</th>
                <th>Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="error-tbody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination">
          <button id="prev-page" disabled>â† Previous</button>
          <span id="page-info">Page 1 of 1</span>
          <button id="next-page" disabled>Next â†’</button>
        </div>
      </div>

      <!-- TAB 2: Console Logs -->
      <div class="tab-panel" id="tab-console">
        <div class="console-controls">
          <button id="console-clear">ğŸ—‘ï¸ Clear</button>
          <input type="text" id="console-filter" placeholder="Filter logs...">
          <select id="console-level">
            <option value="">All Levels</option>
            <option value="log">Log</option>
            <option value="info">Info</option>
            <option value="warn">Warn</option>
            <option value="error">Error</option>
          </select>
          <label class="checkbox"><input type="checkbox" id="console-autoscroll" checked> Auto-scroll</label>
        </div>
        <div class="console-output" id="console-output"></div>
      </div>

      <!-- TAB 3: Network Monitor -->
      <div class="tab-panel" id="tab-network">
        <div class="network-controls">
          <button id="network-clear">ğŸ—‘ï¸ Clear</button>
          <button id="network-export-har">ğŸ“¥ Export HAR</button>
          <select id="network-method">
            <option value="">All Methods</option>
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
          </select>
          <select id="network-status">
            <option value="">All Status</option>
            <option value="2xx">2xx Success</option>
            <option value="4xx">4xx Client Error</option>
            <option value="5xx">5xx Server Error</option>
          </select>
        </div>
        <table class="network-table">
          <thead>
            <tr>
              <th>Method</th>
              <th>URL</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Size</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="network-tbody"></tbody>
        </table>
      </div>

      <!-- TAB 4: Performance Metrics -->
      <div class="tab-panel" id="tab-performance">
        <div class="perf-grid">
          <div class="perf-card">
            <h3>Core Web Vitals</h3>
            <div class="metric"><span>LCP</span><strong id="perf-lcp">â€”</strong></div>
            <div class="metric"><span>FID/INP</span><strong id="perf-inp">â€”</strong></div>
            <div class="metric"><span>CLS</span><strong id="perf-cls">â€”</strong></div>
          </div>
          <div class="perf-card">
            <h3>Timing</h3>
            <div class="metric"><span>DOM Content Loaded</span><strong id="perf-dcl">â€”</strong></div>
            <div class="metric"><span>Load Complete</span><strong id="perf-load">â€”</strong></div>
            <div class="metric"><span>First Paint</span><strong id="perf-fp">â€”</strong></div>
          </div>
          <div class="perf-card">
            <h3>Resources</h3>
            <div class="metric"><span>JS Heap Used</span><strong id="perf-memory">â€”</strong></div>
            <div class="metric"><span>Long Tasks</span><strong id="perf-longtasks">0</strong></div>
          </div>
        </div>
      </div>

      <!-- TAB 5: Redirect Testing -->
      <div class="tab-panel" id="tab-redirects">
        <div class="redirect-controls">
          <button id="redirect-run-diagnostics">ğŸ”„ Run Full Diagnostics</button>
          <button id="redirect-test-root">Test Root (/)</button>
          <button id="redirect-test-en">Test /EN/</button>
          <button id="redirect-clear">ğŸ—‘ï¸ Clear</button>
          <button id="test-all-features" class="test-all-btn">ğŸ§ª Test All Features</button>
        </div>
        <div class="redirect-log" id="redirect-log"></div>
        <div class="redirect-results" id="redirect-results"></div>
      </div>

      <!-- TAB 6: Storage Inspector -->
      <div class="tab-panel" id="tab-storage">
        <div class="storage-section">
          <h3>LocalStorage <button id="storage-ls-refresh" class="icon-btn" title="Refresh">ğŸ”„</button></h3>
          <table id="storage-ls-table" class="storage-table"></table>
        </div>
        <div class="storage-section">
          <h3>SessionStorage <button id="storage-ss-refresh" class="icon-btn" title="Refresh">ğŸ”„</button></h3>
          <table id="storage-ss-table" class="storage-table"></table>
        </div>
        <div class="storage-section">
          <h3>Cookies <button id="storage-cookies-refresh" class="icon-btn" title="Refresh">ğŸ”„</button></h3>
          <table id="storage-cookies-table" class="storage-table"></table>
        </div>
        <div class="storage-section">
          <h3>Service Worker</h3>
          <div id="storage-sw-status" class="storage-sw-status"></div>
          <button id="storage-sw-unregister" class="danger">Unregister SW</button>
        </div>
      </div>

      <!-- TAB 7: System Info -->
      <div class="tab-panel" id="tab-system">
        <table class="system-table">
          <tr><th>Backend Health</th><td id="sys-backend-health">â€”</td></tr>
          <tr><th>Auth Configured</th><td id="sys-auth-configured">â€”</td></tr>
          <tr><th>Auth Source</th><td id="sys-auth-source">â€”</td></tr>
          <tr><th>Worker Version</th><td id="sys-worker-version">â€”</td></tr>
          <tr><th>Build Version</th><td id="sys-build">â€”</td></tr>
          <tr><th>User Agent</th><td id="sys-ua">â€”</td></tr>
          <tr><th>Viewport</th><td id="sys-viewport">â€”</td></tr>
          <tr><th>Device Pixel Ratio</th><td id="sys-dpr">â€”</td></tr>
          <tr><th>Platform</th><td id="sys-platform">â€”</td></tr>
          <tr><th>Language</th><td id="sys-lang">â€”</td></tr>
          <tr><th>Connection</th><td id="sys-connection">â€”</td></tr>
          <tr><th>Online Status</th><td id="sys-online">â€”</td></tr>
          <tr><th>Memory</th><td id="sys-memory">â€”</td></tr>
        </table>
        <div class="system-actions">
          <button id="sys-export-json">ğŸ“¥ Export All Data (JSON)</button>
          <button id="sys-copy-report">ğŸ“‹ Copy Debug Report</button>
          <button id="sys-clear-all" class="danger">ğŸ—‘ï¸ Clear All Data</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Error Detail Modal -->
  <div id="error-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" id="close-modal">&times;</span>
      <h2>Error Details</h2>
      <div id="error-details"></div>
      <div class="modal-actions">
        <select id="modal-category">
          <option value="code_bug">Code Bug</option>
          <option value="async_bug">Async Bug</option>
          <option value="navigation">Navigation</option>
          <option value="connectivity">Connectivity</option>
          <option value="spam">Spam/Bot</option>
          <option value="uncategorized">Uncategorized</option>
        </select>
        <select id="modal-status">
          <option value="new">New</option>
          <option value="investigating">Investigating</option>
          <option value="resolved">Resolved (Auto-Delete)</option>
          <option value="ignored">Ignored</option>
        </select>
        <button id="save-error">Save Changes</button>
        <button id="delete-error" class="danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- V12 Diagnostics Telemetry (always available on dashboard) -->
  <script src="/assets/js/telemetry-core.min.js"></script>
  <script>
    (function () {
      try {
        if (!window.__SavonieDiagnosticsConsent) {
          const KEYS = {
            consent: 'site_diagnostics_consent',
            upload: 'site_diagnostics_upload',
            asked: 'site_diagnostics_asked'
          };

          const storage = {
            type: (function () {
              try {
                const k = '__ls_test__';
                localStorage.setItem(k, '1');
                localStorage.removeItem(k);
                return 'localStorage';
              } catch {
                return 'cookie';
              }
            })(),
            set: function (k, v) {
              if (this.type === 'localStorage') {
                try { localStorage.setItem(k, v); } catch {}
                return;
              }
              try { document.cookie = encodeURIComponent(k) + '=' + encodeURIComponent(v) + '; path=/; SameSite=Lax'; } catch {}
            },
            get: function (k) {
              if (this.type === 'localStorage') {
                try { return localStorage.getItem(k); } catch { return null; }
              }
              try {
                const m = document.cookie.match(new RegExp('(?:^|; )' + encodeURIComponent(k) + '=([^;]*)'));
                return m ? decodeURIComponent(m[1]) : null;
              } catch {
                return null;
              }
            }
          };

          const getState = function () {
            return {
              consent: storage.get(KEYS.consent),
              upload: storage.get(KEYS.upload) === 'on',
              asked: storage.get(KEYS.asked) === '1',
              storage: storage.type
            };
          };

          window.__SavonieDiagnosticsConsent = {
            get: getState,
            set: function (o) {
              try {
                if (o && typeof o.consent === 'string') storage.set(KEYS.consent, o.consent);
                if (o && typeof o.upload === 'boolean') storage.set(KEYS.upload, o.upload ? 'on' : 'off');
                storage.set(KEYS.asked, '1');
              } catch {}
            },
            revoke: function () {
              try {
                storage.set(KEYS.consent, 'denied');
                storage.set(KEYS.upload, 'off');
                storage.set(KEYS.asked, '1');
                window.__SavonieTelemetry && window.__SavonieTelemetry.disable && window.__SavonieTelemetry.disable();
              } catch {}
            },
            clearData: function () {
              try { window.__SavonieTelemetry && window.__SavonieTelemetry.clear && window.__SavonieTelemetry.clear(); } catch {}
            }
          };

          // Default to granted for authenticated dashboard usage
          if (!storage.get(KEYS.consent)) {
            storage.set(KEYS.consent, 'granted');
            storage.set(KEYS.upload, 'off');
            storage.set(KEYS.asked, '1');
          }
        }

        // Enable telemetry so breadcrumbs/network/perf hooks attach immediately.
        if (window.__SavonieTelemetry && typeof window.__SavonieTelemetry.enable === 'function') {
          window.__SavonieTelemetry.enable({ upload: false, mode: 'dev' });
        }
      } catch {}
    })();
  </script>
  <script src="/assets/js/debugger-hud.min.js"></script>
  <script>
    (function () {
      try {
        if (window.__SavonieHUD && !window.Savonie) window.Savonie = window.__SavonieHUD;
      } catch {}
    })();
  </script>
  
  <script src="/assets/js/dashboard.js?v=36c2000"></script>
</body>
</html>
