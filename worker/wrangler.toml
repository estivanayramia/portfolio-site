name = "portfolio-worker"
main = "debugger-worker.js"
compatibility_date = "2024-01-01"
workers_dev = true

# This is the DEFAULT wrangler config in the worker/ directory.
# Workers Builds uses this when root_dir = "worker/" and deploy command = default.
# The dashboard worker "portfolio-worker" serves the debugger/error-reporting API.
#
# For the chat worker, use:  npx wrangler deploy --config wrangler.chat.toml
# For manual debugger deploys to "portfolio-api-debugger", use:
#   npx wrangler deploy --config wrangler.debugger.toml

# Debugger/ingestion worker owns these endpoints.
routes = [
  # bare domain
  { pattern = "estivanayramia.com/api/error-report", zone_name = "estivanayramia.com" },
  { pattern = "estivanayramia.com/api/errors*", zone_name = "estivanayramia.com" },
  { pattern = "estivanayramia.com/api/auth", zone_name = "estivanayramia.com" },
  { pattern = "estivanayramia.com/api/health", zone_name = "estivanayramia.com" },
  { pattern = "estivanayramia.com/health", zone_name = "estivanayramia.com" },
  # www (dashboard lives here)
  { pattern = "www.estivanayramia.com/api/error-report*", zone_name = "estivanayramia.com" },
  { pattern = "www.estivanayramia.com/api/errors*", zone_name = "estivanayramia.com" },
  { pattern = "www.estivanayramia.com/api/auth*", zone_name = "estivanayramia.com" },
  { pattern = "www.estivanayramia.com/api/health", zone_name = "estivanayramia.com" },
  { pattern = "www.estivanayramia.com/health", zone_name = "estivanayramia.com" },
]

# D1 Database for error monitoring
[[d1_databases]]
binding = "DB"
database_name = "portfolio-errors"
database_id = "90a1df04-e5b9-48b9-90f4-02e3fb773ca8"

# KV storage for sessions + rate limiting
[[kv_namespaces]]
binding = "SAVONIE_KV"
id = "e723b1dbdc9a40a6b6ccd04764108d6c"

[vars]
SERVICE_NAME = "portfolio-worker"
RATE_LIMIT_MAX = "10"
RATE_LIMIT_WINDOW = "60000"

# Secrets (set via Cloudflare dashboard or `wrangler secret put`):
# - DASHBOARD_PASSWORD (plain) OR DASHBOARD_PASSWORD_HASH (sha256 hex or plain)

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

[observability.traces]
enabled = true
head_sampling_rate = 1
persist = true

